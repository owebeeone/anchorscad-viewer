# AnchorSCAD Viewer (Grip React Demo)

This package is a minimal, production-ready demo application that showcases the Grip React state engine (`@owebeeone/grip-react`) by browsing and previewing models generated by AnchorSCAD.

It loads a pre-generated `public/status.json`, presents navigation over modules, shapes, and examples, and renders:
- 3D meshes (STL) with Three.js
- PNG preview images
- Graph visualizations (SVG)
- OpenSCAD source (Scad Code)
- Python source (Code) with deep links back to GitHub and line highlighting

## Quick start

Prerequisites:
- Node.js 18+

Install and run:

```bash
cd anchorscad-viewer
npm install
npm run dev
```

Build and preview production:

```bash
npm run build
npm run preview
```

## Data model

The app reads `public/status.json` which contains module/shape/example metadata and output file paths. The important fields used in the viewer include:
- Module-level: `module_name`, `source_repo { repo_name, commit_id, file_path_in_repo, is_on_origin }`
- Shape-level: `class_name`, `line_number`
- Example-level: `png_file`, `stl_file`, `scad_file`, `graph_svg_file`

When a model is selected, the viewer derives and exposes:
- `CURRENT_SOURCE_GITHUB_URL` and `CURRENT_SOURCE_LINE_NUMBER` (to link and highlight the Python source)
- `CURRENT_SOURCE_RAW_URL` (to fetch the Python file; local copy if provided, otherwise raw GitHub)

## Integration with Grip React

Grip React supplies a declarative dataflow model:
- Grips are typed, named handles for values (e.g., `ALL_MODULES_LIST`, `CURRENT_STL_PATH`).
- Taps are producers that compute or fetch and then publish to grips.
- Components consume grips via `useGrip` and update atoms via `useGripSetter`.

Key files:
- `src/grips.ts`: defines all grips and atom handles
- `src/taps.ts`: registers taps that populate grips
  - `createStatusJsonFetcherTap` loads `status.json`
  - `createGlobalNavigationDataProviderTap` derives `ALL_MODULES_LIST`
  - `createModuleFilterTap` creates `FILTERED_MODULES_LIST` from a filter string
  - `createModuleSpecificNavigationTap` derives `MODELS_IN_SELECTED_MODULE_LIST` and `CURRENT_SOURCE_RAW_URL`
  - `createModelResourceProviderTap` derives model-specific outputs and source GitHub link/line
  - `createCodeTextLoaderTap` loads OpenSCAD text
  - `createSourceCodeLoaderTap` loads Python source text
- `src/main.tsx`: registers taps and atom taps with the `GripProvider`
- `src/components/*`: presentational components that render viewers and navigation

### Atom taps (UI State)
We use atom taps to manage UI state:
- `VIEW_MODE`, `ACTIVE_TAB`
- Selection: `SELECTED_MODULE_NAME`, `SELECTED_SHAPE_NAME`, `SELECTED_EXAMPLE_NAME`, `SELECTED_PART_NAME`
- Module filter: `MODULE_FILTER_STRING` (updated by the search box)

All atom taps are constructed with `createAtomValueTap` in `src/taps.ts` and registered in `src/main.tsx`.

### Example: module filtering
- `MODULE_FILTER_STRING` holds the space-separated filter tokens
- `createModuleFilterTap` listens to `[ALL_MODULES_LIST, MODULE_FILTER_STRING]` and publishes `FILTERED_MODULES_LIST`
- `ModuleBrowser` reads `FILTERED_MODULES_LIST` (fallback to `ALL_MODULES_LIST`), rendering a preview image and truncated name

## UI highlights
- Module list includes a search filter (with clear “×” button), preview thumbnail, and tooltip with the full module name
- New tabs:
  - `Code` (Python): syntax highlighted, deep link to GitHub, auto-scroll and highlight to the relevant line
  - `Scad Code` (OpenSCAD): syntax highlighted, loads from generated files

## Project layout
- Built with Vite + React + TypeScript + Tailwind CSS
- 3D view: `@react-three/fiber` and `@react-three/drei`
- Syntax highlighting: `react-syntax-highlighter`

## Developing
- Taps are composable; prefer small, single-purpose taps that publish only what they own
- Keep hooks stable in components (avoid conditional hook calls)
- Use `useGrip` for reading, `useGripSetter` for writing atom values

## Licensing
This demo is part of the AnchorSCAD dev workspace and intended as a reference for integrating `@owebeeone/grip-react` in real-world apps.
